{% extends "ptr_template.html" %}
{% block title %}pull_transaction_report.py{% endblock %}
{% block head_js_block %}
  <script type="text/javascript">
    $(document).ready(function() { 
      {% for scheme in schemes %}
      $('.mainTable-{{scheme}}').tablesorter({
        debug: true,
        theme: '{{scheme}}',
        cssChildRow: "tablesorter-childRow",
        cssInfoBlock: "tablesorter-no-sort",
        sortInitialOrder: "desc",
        widgets:['zebra'],
        widgetOptions: {
            zebra: ["odd", "even"],
        },
        headers: {
           {% for key in lheadings %}{{loop.index0}}: { sorter: "{{lheadings[key]}}" },{% endfor %}
        }
       });
      {% endfor %}
      $('.tablesorter-childRow td').hide();
      $('.tablesorter').delegate('.toggle', 'click', function() {
        $(this).closest('tr').nextUntil('tr:not(.tablesorter-childRow)').find('td').toggle();
        return false;
      });
    });
  </script>
  <!--
  <script type="text/javascript">
    function ChangeColor(tableRow, highLight, outLight) {
      if (highLight) {
        tableRow.style.backgroundColor = '#6666ff';
      } else {
        tableRow.style.backgroundColor = outLight;
      }
    }
    function DoNav(theUrl,theName) {
      //document.location.href = theUrl;
      window.open(theUrl,theName);
    }
  </script>
  -->
{% endblock %}


{% block body_block %}
<div><p><a href="{{legacy_link}}">{{legacy_link}}</a></p></div>
<div>
    {% for fileportname in tldict %}
        <table class="mainTable-{{schemes[loop.index0 % schemes|length]}} tablesorter" border="1">
            <!-- Header Row -->
            <thead><tr>{% for key in lheadings %}<th>{{key}}</th>{% endfor %}</tr></thead>
            <tfoot><tr>{% for key in lheadings %}<th>{{key}}</th>{% endfor %}</tr></tfoot>
            <!-- Non-sorting Name Row -->
            <tbody class="tablesorter-no-sort"><tr><td colspan="{{lheadings|length}}">{{fileportname}}</td></tr></tbody>
            <!-- Long Positions -->
            {% if tldict[fileportname].combined_positions['longs']|length > 0 %}
                <tbody class="tablesorter-no-sort"><tr><td colspan="{{lheadings|length}}">Long Positions</td></tr></tbody>
                <tbody>
                    {% for symbol in tldict[fileportname].combined_positions['longs'] %}
                        <tr>
                            {% for key in lheadings %}
                                {% if key == 'Symb' %}
                                    {% if tldict[fileportname].combined_positions['longs'][symbol].report['transactions']|length > 1 %}
                                        <td rowspan="{{tldict[fileportname].combined_positions['longs'][symbol].report['transactions']|length + 1}}"><a href="#" class="toggle">{{tldict[fileportname].combined_positions['longs'][symbol].report[key][0].format(tldict[fileportname].combined_positions['longs'][symbol].report[key][1])}}</a></td>
                                    {% else %}
                                        <td>{{tldict[fileportname].combined_positions['longs'][symbol].report[key][0].format(tldict[fileportname].combined_positions['longs'][symbol].report[key][1])}}</td>
                                    {% endif %}
                                {% else %}
                                    <td>{{tldict[fileportname].combined_positions['longs'][symbol].report[key][0].format(tldict[fileportname].combined_positions['longs'][symbol].report[key][1])}}</td>
                                {% endif %}
                            {% endfor %}<!--key-->
                        </tr>
                        <!-- Transactions Within A Position -->
                        {% if tldict[fileportname].combined_positions['longs'][symbol].report['transactions']|length > 1 %}
                            {% for subreport in tldict[fileportname].combined_positions['longs'][symbol].report['transactions'] %}
                                <tr class="tablesorter-childRow">
                                    {% for key in lheadings %}
                                        {% if key != 'Symb' %}<td>{{subreport[key][0].format(subreport[key][1])}}</td>{% endif %}
                                    {% endfor %}<!--key-->
                                </tr>
                            {% endfor %}<!--subreport-->
                        {% endif %}<!--tldict-->
                    {% endfor %}<!--symbol-->
                </tbody>
            {% endif %}<!--tldict-->
            
            <!-- Short Positions -->
            {% if tldict[fileportname].combined_positions['shorts']|length > 0 %}
                <tbody class="tablesorter-no-sort"><tr><td colspan="{{lheadings|length}}">Short Positions</td></tr></tbody>
                <tbody>
                    {% for symbol in tldict[fileportname].combined_positions['shorts'] %}
                        <tr>
                            {% for key in lheadings %}
                                <td>{{tldict[fileportname].combined_positions['shorts'][symbol].report[key][0].format(tldict[fileportname].combined_positions['shorts'][symbol].report[key][1])}}</td>
                            {% endfor %}<!--key-->
                        </tr>
                    {% endfor %}<!--symbol-->
                </tbody>
            {% endif %}<!--tldict-->
            
            <!-- Option Positions -->
            {% if tldict[fileportname].combined_positions['options']|length > 0 %}
                <tbody class="tablesorter-no-sort"><tr><td colspan="{{lheadings|length}}">Option Positions</td></tr></tbody>
                <tbody>
                    {% for symbol in tldict[fileportname].combined_positions['options'] %}
                        <tr>
                            {% for key in lheadings %}
                                <td>{{tldict[fileportname].combined_positions['options'][symbol].report[key][0].format(tldict[fileportname].combined_positions['options'][symbol].report[key][1])}}</td>
                            {% endfor %}<!--key-->
                        </tr>
                    {% endfor %}<!--symbol-->
                </tbody>
            {% endif %}<!--tldict-->
            
            <!-- Cash Position -->
            {% if tldict[fileportname].combined_positions['cash']|length > 0 %}
                <tbody class="tablesorter-no-sort"><tr><td style="color:white;background-color:green;" colspan="{{lheadings|length}}">Cash Position</td></tr></tbody>
                <tbody>
                    {% for symbol in tldict[fileportname].combined_positions['cash'] %}
                        <tr>
                            {% for key in lheadings %}
                                {% if key == 'Symb' %}
                                    {% if tldict[fileportname].combined_positions['cash'][symbol].report['transactions']|length > 1 %}
                                        <td rowspan="{{tldict[fileportname].combined_positions['cash'][symbol].report['transactions']|length + 1}}"><a href="#" class="toggle">{{tldict[fileportname].combined_positions['cash'][symbol].report[key][0].format(tldict[fileportname].combined_positions['cash'][symbol].report[key][1])}}</a></td>
                                    {% else %}
                                        <td>{{tldict[fileportname].combined_positions['cash'][symbol].report[key][0].format(tldict[fileportname].combined_positions['cash'][symbol].report[key][1])}}</td>
                                    {% endif %}
                                {% else %}<!--key-->
                                    {% if key in tldict[fileportname].combined_positions['cash'][symbol].report %}
                                        <td>{{tldict[fileportname].combined_positions['cash'][symbol].report[key][0].format(tldict[fileportname].combined_positions['cash'][symbol].report[key][1])}}</td>
                                    {% else %}
                                        <td></td>
                                    {% endif %}
                                {% endif %}<!--key-->
                            {% endfor %}<!--key-->
                        </tr>
                        <!-- Cash sub transactions -->
                        {% if tldict[fileportname].combined_positions['cash'][symbol].report['transactions']|length > 1 %}
                            {% for subreport in tldict[fileportname].combined_positions['cash'][symbol].report['transactions'] %}
                                <tr class="tablesorter-childRow">
                                    {% for key in lheadings %}
                                        {% if key != 'Symb' %}
                                            {% if key in subreport %}
                                                <td>{{subreport[key][0].format(subreport[key][1])}}</td>
                                            {% else %}
                                                <td></td>
                                            {% endif %}
                                        {% endif %}<!--key-->
                                    {% endfor %}<!--key-->
                                </tr>
                            {% endfor %}<!--subreport-->
                        {% endif %}<!--tldict-->
                    {% endfor %}<!--symbol-->
                </tbody>
            {% endif %}<!--tldict-->
            <!-- Total Position -->
            {% if tldict[fileportname].totals|length > 0 %}
                <tbody class="tablesorter-no-sort"><tr><td style="color:white;background-color:green;" colspan="{{lheadings|length}}">Total</td></tr></tbody>
                <tbody>
                    <tr>
                        {% for key in lheadings %}
                            {% if key in tldict[fileportname].totals %}
                                <td>{{tldict[fileportname].totals[key][0].format(tldict[fileportname].totals[key][1])}}</td>
                            {% else %}
                                <td></td>
                            {% endif %}
                        {% endfor %}<!--key-->
                    </tr>
                </tbody>
            {% endif %}<!--tldict-->
        </table>
    {% endfor %}<!--fileportname-->
</div>
{% endblock %}

